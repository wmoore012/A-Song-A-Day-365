<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>THE NUKES — Song-A-Day 365</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Anton&family=Rajdhani:wght@600;700&family=Inter:wght@400;700;900&display=swap" rel="stylesheet">

  <!-- Leaflet / Chart.js -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- YouTube IFrame API (audio only) -->
  <script src="https://www.youtube.com/iframe_api"></script>

  <link rel="stylesheet" href="./nukes-v2.css">
</head>
<body>
  <div class="wrap">

    <!-- HUD (Now Playing + FX toggle) -->
    <header class="hud-header" role="banner" aria-label="HUD">
      <div class="hud-title sporty">SONG‑PER‑DAY‑365</div>
      <div id="hudNowPlaying" class="hud-nowplaying" aria-live="polite">Now Playing: —</div>
    </header>

    <header class="topbar">
      <button id="menuToggle" class="btn btn-secondary" style="margin-right:8px">☰</button>
      <nav id="menuPanel" class="panel hidden" style="position:fixed;inset:auto 18px 18px auto;z-index:300;width:min(320px,92vw);display:none">
        <div class="panel-card">
          <div class="panel-hd"><h3>Menu</h3><button class="btn btn-secondary" onclick="document.getElementById('menuPanel').classList.remove('open');document.getElementById('menuPanel').style.display='none'">Close</button></div>
          <button class="btn btn-secondary" onclick="document.querySelector('.hud-grid')?.scrollIntoView({behavior:'smooth'})">Analytics</button>
          <button class="btn btn-secondary" onclick="document.getElementById('settingsPanel')?.classList.remove('hidden')">Settings</button>
          <button class="btn btn-secondary" onclick="document.getElementById('cityPanel')?.classList.remove('hidden')">City</button>
        </div>
      </nav>
      <div class="brand">
        <img src="assets/brand.svg" alt="" onerror="this.style.display='none'"/>
        <span class="title">THE NUKES</span>
        <span class="subtitle">Song-A-Day 365</span>
      </div>
      <div class="chips">
        <div class="chip">🔥 Streak <b id="streak">0</b></div>
        <div class="chip">🧊 Freezes <b id="freezes">0</b></div>
        <div class="chip flip" id="flipClock">00:00</div>
        <button id="villainMuteChip" class="chip" aria-pressed="false" title="Mute villain">🔇 Villain</button>
      </div>
    </header>

    <div id="lobbyBackdrop" aria-hidden="true"></div>

    <main class="grid">
      <section class="card focus">
        <div class="card-hd">
          <h2>Lock-in</h2>
          <div class="tip-tag" id="tipTag">“Make the ugly version. Ship it.”</div>
        </div>

        <div class="songtitle-row">
          <input id="songTitle" class="song-title" placeholder="Song title (optional)" aria-label="Song title" />
          <small class="muted">You can set or change this anytime.</small>
        </div>

        <div class="latency">
          <div class="caption">You’ve got <b>7:00</b> to lock in.</div>
          <div class="big flip" id="latencyCountdown">07:00</div>
          <div class="muted">Start latency: <b id="latencyMs">—</b></div>
        </div>

        <div class="action-row">
          <button id="startBtn" class="btn btn-primary">🚀 Start Work</button>
          <button id="doneBtn" class="btn btn-good" disabled>🎉 Mark Done</button>
          <button id="freezeBtn" class="btn btn-warn">🧊 Use Freeze</button>
        </div>

        <div id="messageBar" class="message">Tip: Don’t plan 20 steps. Do the first one only.</div>
        <div id="multiplier" class="mult">
          <div class="label">Multiplier: <span id="multVal">100%</span></div>
          <div class="bar"><div id="multBar"></div></div>
        </div>
        <div class="divider"></div>

        <div class="heat">
          <div class="heat-hd">Heat check</div>
          <div class="heat-row">
            <button id="heatDrums" class="heat-btn" title="Drums hot">🥁🔥<span class="badge" aria-hidden="true">0</span></button>
            <button id="heatVocals" class="heat-btn" title="Vocal melody hot">🎤🔥<span class="badge" aria-hidden="true">0</span></button>
            <button id="heatKeys" class="heat-btn" title="Keys / Guitars hot">🎹🔥<span class="badge" aria-hidden="true">0</span></button>
            <button id="heatLyrics" class="heat-btn" title="Lyrics hot">✍️<span class="badge" aria-hidden="true">0</span></button>
            <button id="heatBass" class="heat-btn" title="Bass hot">🔊🔥<span class="badge" aria-hidden="true">0</span></button>
          </div>
        </div>

        <div id="fireLayer" class="fire-layer"></div>

        <div class="ifthen">
          <div class="ifthen-hd">If-Then Checks</div>
          <label class="tgl"><input type="checkbox" id="igClosed"> IG CLOSED</label>
          <label class="tgl"><input type="checkbox" id="fbClosed"> FACEBOOK CLOSED</label>
          <label class="tgl"><input type="checkbox" id="ytConsidered"> YT CONSIDERED</label>
        </div>

        <div class="quicklinks">
          <a class="btn btn-secondary" target="_blank" href="https://music.youtube.com/">🎵 YouTube Music</a>
          <button id="openVibes" class="btn btn-secondary">🏠 Studio Vibes</button>
          <a class="btn btn-secondary" target="_blank" href="https://www.focusmate.com/">👥 Focusmate</a>
        </div>

        <div class="nowplaying">
          <span class="np-label">Now Playing:</span>
          <span id="npTitle" class="np-title">—</span>
          <button id="hintsBtn" class="btn btn-secondary" style="margin-left:auto" onclick="openHints()">?📈 Hints</button>
        </div>

        <button id="armAudio" class="btn btn-volt arm">🔊 Enable Sound</button>
        <div class="audio-row">
          <button id="toggleNoise" class="btn btn-secondary">🌧️ White Noise</button>
          <span class="muted small">Music vol 15% · Noise vol 15%</span>
        </div>
      </section>

      <section class="card">
        <div id="lockinTicker" class="ticker muted small" aria-label="Lock-in Tips"></div>
        <div class="card-hd">
          <h2>City + Weather</h2>
          <button id="openCity" class="btn btn-secondary">🌆 City</button>
        </div>
        <div id="weatherBox" class="weather">Charlotte, NC — loading weather…</div>
        <div id="map" class="map"></div>
      </section>

      <section class="card">
        <div class="card-hd"><h2>Insights</h2></div>
        <div class="charts">
          <canvas id="chartGrades" height="160"></canvas>
          <div class="muted">Success grade (last 14)</div>
          <canvas id="chartLatency" height="160"></canvas>
          <div class="muted">Start latency (ms) — lower is better</div>
        </div>
        <div class="grade">
          <div class="grade-hd">
            <span>Grade today</span>
            <span class="cd" id="cd">💿</span>
          </div>
          <input type="range" min="0" max="100" value="60" id="gradeSlider" />
          <button id="saveGrade" class="btn btn-secondary">Save Grade</button>
        </div>
      </section>
    </main>
  </div>

  <!-- Analytics HUD panel (placeholders) -->
  <section id="hudAnalytics" class="hud-grid">
    <div id="chartStreak" class="hud-card hud-echarts" aria-label="Streak momentum chart"></div>
    <div id="chartBars" class="hud-card hud-echarts" aria-label="Freezes and Genres"></div>
    <div id="chartCalendar" class="hud-card hud-echarts" aria-label="Calendar heatmap"></div>
    <div id="chartMultiplier" class="hud-card hud-echarts" aria-label="Multiplier gauge"></div>
  </section>

  <!-- Coming-Soon frosted card -->
  <div class="coming-soon card-frost panel-animated" role="note">
    <div class="sporty">Portfolio &amp; iCatalog Builder</div>
    <p>Coming Soon — wired to your Notion/iCatalog stats.</p>
  </div>

  <!-- ECharts + GSAP (CDN) for HUD analytics; safe if network blocked -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gsap@3/dist/gsap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gsap@3/dist/ScrollTrigger.min.js"></script>

  <!-- Villain chat -->
  <aside id="chatDock" class="chat-dock">
  <button id="chatToggle" class="chat-tab">😈 Heel</button>
    <div class="chat-wrap">
            <div class="chat-head">
	  <div id="sidekickHeader">😈 Heel</div>
	  <div class="muted small">LLM Mode: <span id="llmModeLabel">Off</span></div>
	  <div style="display:flex;gap:6px">
	    <button id="openSettings" class="btn btn-secondary" style="padding:6px 10px;font-size:12px" title="Settings">⚙️</button>
	    <button id="chatCloseBtn" class="btn btn-secondary" style="padding:6px 10px;font-size:12px" title="Close">✖️</button>
	  </div>
      </div>
      <div id="chatLog" class="chat-log"></div>
  <div class="kbd" id="kbd">
        <div class="row"><span data-k="Q">Q</span><span data-k="W">W</span><span data-k="E">E</span><span data-k="R">R</span><span data-k="T">T</span><span data-k="Y">Y</span><span data-k="U">U</span><span data-k="I">I</span><span data-k="O">O</span><span data-k="P">P</span></div>
        <div class="row"><span data-k="A">A</span><span data-k="S">S</span><span data-k="D">D</span><span data-k="F">F</span><span data-k="G">G</span><span data-k="H">H</span><span data-k="J">J</span><span data-k="K">K</span><span data-k="L">L</span></div>
        <div class="row"><span data-k="Z">Z</span><span data-k="X">X</span><span data-k="C">C</span><span data-k="V">V</span><span data-k="B">B</span><span data-k="N">N</span><span data-k="M">M</span></div>
      </div>
      <form id="chatForm" class="chat-form">
        <input id="chatInput" placeholder="Turn on LLM & Send message to …" />
        <button class="btn btn-volt" type="submit">Send</button>
      </form>
      <details class="chat-settings">
        <summary>LLM Settings (optional)</summary>
        <label>OpenRouter API Key <input id="openrouterKey" placeholder="sk-or-..." /></label>
        <label>Model <input id="openrouterModel" value="mistralai/mistral-small" /></label>
        <button id="saveLLM" class="btn btn-secondary" type="button">Save</button>
      </details>
    </div>
  </aside>

  <!-- City panel -->
  <div id="cityPanel" class="panel hidden">
    <div class="panel-card">
      <div class="panel-hd">
        <h3>Set City</h3>
        <button id="closeCity" class="btn btn-secondary">Close</button>
      </div>
      <div class="city-row">
        <input id="cityInput" placeholder="Enter city (e.g., Charlotte, NC)" />
        <button id="cityFind" class="btn btn-secondary">📍 Set City</button>
        <button id="useGeo" class="btn btn-secondary">🛰️ Use My Location</button>
      </div>
      <div class="muted small">Default is Charlotte, NC. Map is non-interactive on purpose.</div>
    </div>
  </div>

  <!-- Settings panel -->
  <div id="settingsPanel" class="panel hidden">
    <div class="panel-card">
      <div class="panel-hd">
        <h3>Settings</h3>
        <button id="closeSettings" class="btn btn-secondary">Close</button>
      </div>
      <label class="tgl">Accountability emails (comma‑separated)</label>
      <input id="acctEmails" placeholder="a@b.com, c@d.com" />
      <div class="divider"></div>
      <label class="tgl">Studio Vibes source (YouTube Video or Playlist URL)</label>
      <input id="vibesUrl" placeholder="https://youtu.be/... or https://youtube.com/playlist?..." />
      <small class="muted">Inspiring visuals for your session (your choice of ambient studio vibes).</small>
      <div class="divider"></div>
      <label class="tgl">Music playlist (Now Playing at startup)</label>
      <input id="musicUrl" placeholder="https://youtube.com/playlist?list=... (optional)" />
      <small class="muted">Defaults to the built-in playlist unless you set one here.</small>
      <div class="divider"></div>
      <label class="tgl">Villain Emoji Builder</label>
      <div id="villainWarning" class="muted" style="background:#071008;border:1px solid #236d42;border-radius:10px;padding:8px;color:#b6ff00;font-family:monospace;box-shadow:0 0 10px rgba(182,255,0,.35)">Warning… this is all make believe, but not everybody will think that! so 9x out of 10 it’s better to use one of the non‑humans emojis lol — Use at your own risk</div>
      <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:8px">
        <label>Subject
          <select id="villainSubject"><option value="nonhuman">Non‑human</option><option value="human">Human</option></select>
        </label>
        <label>Presenting
          <select id="villainPresenting"><option value="neutral">Neutral</option><option value="male">Male</option><option value="female">Female</option></select>
        </label>
        <label>Age
          <select id="villainAge"><option value="adult">Adult</option><option value="old">Old</option></select>
        </label>
        <label>Hair
          <select id="villainHair"><option value="default">Default</option><option value="short">Short</option><option value="long">Long</option></select>
        </label>
        <label class="tgl"><input type="checkbox" id="villainBeard"> Beard (male only)</label>
        <label>Skin tone
          <select id="villainTone"><option value="light">Light</option><option value="mediumLight">Medium‑light</option><option value="medium" selected>Medium</option><option value="mediumDark">Medium‑dark</option><option value="dark">Dark</option></select>
        </label>
        <label>Non‑human emoji
          <select id="villainNonHuman"><option>😈</option><option>👹</option><option>💀</option><option>🤖</option><option>👾</option><option>🦂</option><option>🐍</option></select>
        </label>
      </div>
      <div class="divider"></div>
      <label class="tgl">White noise source (YouTube URL)</label>
      <input id="noiseUrl" placeholder="https://www.youtube.com/watch?v=..." />
      <small class="muted">Pick your favorite white-noise/room/lofi ambience.</small>
      <div class="divider"></div>
      <label class="tgl">Hints videos (one YouTube URL per line)</label>
      <textarea id="hintsList" placeholder="https://www.youtube.com/watch?v=...\nhttps://www.youtube.com/watch?v=..." style="width:100%;min-height:100px;background:#0f0f18;border:1px solid var(--line);border-radius:12px;color:#fff;padding:10px"></textarea>
      <small class="muted">Name some idea-sparking clips we should suggest if you get stuck mid‑session.</small>
      <div style="margin-top:8px">
        <button id="saveSettings" class="btn btn-primary">Save</button>
      </div>
    </div>
  </div>

  <!-- First-run Setup panel -->
  <div id="setupPanel" class="panel hidden">
    <div class="panel-card">
      <div class="panel-hd">
        <h3>Quick Setup</h3>
      </div>
      <label class="tgl">Name your heel (😈)</label>
      <input id="setupName" placeholder="e.g., Coach, Nemesis, Drill Sgt." />
      <div class="divider"></div>
      <label class="tgl">Heel theme</label>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <label class="tgl"><input type="radio" name="heelTheme" value="masc" checked> Masc (male)</label>
        <label class="tgl"><input type="radio" name="heelTheme" value="fem"> Fem (female)</label>
        <label class="tgl"><input type="radio" name="heelTheme" value="custom"> Other (provide GIF URLs)</label>
      </div>
      <textarea id="setupHeelGifs" placeholder="One GIF URL per line (only used for Other)" style="width:100%;min-height:80px;background:#0f0f18;border:1px solid var(--line);border-radius:12px;color:#fff;padding:10px"></textarea>
      <div class="divider"></div>
      <label class="tgl">Studio Vibes source (YouTube Video or Playlist URL)</label>
      <input id="setupVibesUrl" placeholder="https://youtu.be/... or https://youtube.com/playlist?..." />
      <small class="muted">No default: add your own video/playlist.</small>
      <div class="divider"></div>
      <label class="tgl">Music playlist (startup Now Playing; optional)</label>
      <input id="setupMusicUrl" placeholder="https://youtube.com/playlist?list=... (optional)" />
      <div class="divider"></div>
      <label class="tgl">Spicy level (tone)</label>
      <input id="setupTone" type="range" min="0" max="2" value="1" />
      <div class="muted small">Moving this slider may enable LLM replies for dynamic tone. This uses your API key if configured.</div>
      <div style="margin-top:10px">
        <button id="setupSave" class="btn btn-primary">Save</button>
      </div>
    </div>
  </div>

  <!-- Overlays -->
  <div id="rewardModal" class="overlay hidden">
    <div class="modal">
      <h3 id="rewardTitle">🎁 Gear Drop</h3>
      <img id="rewardGif" alt="" />
      <div id="rewardCap" class="muted"></div>
      <button class="btn btn-volt" onclick="document.getElementById('rewardModal').classList.add('hidden')">OK</button>
    </div>
  </div>
  <div id="runOverlay" class="overlay hidden">
    <div class="modal">
      <h3>🏃 RUN!</h3>
      <img id="runGif" alt="" />
      <button class="btn btn-volt" onclick="document.getElementById('runOverlay').classList.add('hidden')">On it</button>
    </div>
  </div>
  <div id="successHome" class="overlay hidden">
    <div class="modal">
      <h3>Wrap. We’re out. ✅</h3>
      <img id="successGif" alt="" />
      <button class="btn btn-good" onclick="document.getElementById('successHome').classList.add('hidden')">Peace</button>
    </div>
  </div>
  <!-- End-of-session Survey overlay -->
  <div id="surveyModal" class="overlay hidden">
    <div class="modal">
      <h3>Quick survey</h3>
      <div class="muted">What best describes today?</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:8px 0">
  <label class="tgl"><input type="checkbox" id="surveyAllNighter"> All-nighter (counts for previous day)</label>
        <label class="tgl"><input type="radio" name="surveyChoice" value="Scope too big"> Scope too big</label>
        <label class="tgl"><input type="radio" name="surveyChoice" value="Distraction"> Distraction</label>
        <label class="tgl"><input type="radio" name="surveyChoice" value="Low energy"> Low energy</label>
        <label class="tgl"><input type="radio" name="surveyChoice" value="Other"> Other</label>
      </div>
      <label class="tgl"><input type="checkbox" id="surveyAllNighter"> All-nighter (counts for previous day)</label>
      <textarea id="surveyNote" placeholder="Optional note" style="width:100%;min-height:80px;background:#0f0f18;border:1px solid var(--line);border-radius:12px;color:#fff;padding:10px"></textarea>
      <div style="margin-top:10px;display:flex;gap:8px;justify-content:center">
        <button id="submitSurvey" class="btn btn-primary">Submit</button>
        <button id="skipSurvey" class="btn btn-secondary">Skip</button>
      </div>
    </div>
  </div>
  <div id="failHome" class="overlay hidden">
    <div class="modal twin">
      <div>
        <h3 class="danger">We failed today.</h3>
        <img id="failGif" alt="" />
      </div>
      <div class="wall"></div>
      <div>
        <div class="muted">Villain watching from the sidelines. Tighten up tomorrow.</div>
        <img id="willGif" alt="" />
      </div>
      <button class="btn btn-bad" onclick="document.getElementById('failHome').classList.add('hidden')">I’ll fix it</button>
    </div>
  </div>

  <!-- Hints overlay -->
  <div id="hintsModal" class="overlay hidden">
    <div class="modal">
      <h3>Hints</h3>
      <p class="muted">Short coaching clips. Music fades while hints play.</p>
      <div id="hintPlayerHost" style="aspect-ratio:16/9;background:#0f0f18;border:1px solid var(--line);border-radius:12px;padding:8px"></div>
      <div style="margin-top:8px">
        <a id="openInYoutube" class="btn btn-secondary" target="_blank">Open in YouTube</a>
        <button class="btn btn-volt" onclick="closeHints()">Close</button>
      </div>
    </div>
  </div>

  <!-- Action Nudge overlay -->
  <div id="nudgeModal" class="overlay hidden">
    <div class="modal">
      <h3>What’s the move?</h3>
      <div style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center">
        <button id="nudgeEightBar" class="btn btn-secondary">8 bars then bounce</button>
        <button id="nudgeMoreTime" class="btn btn-secondary">I need more time</button>
        <button id="nudgeCloseSocial" class="btn btn-secondary">Close social tabs</button>
        <button id="nudgeFocusmate" class="btn btn-secondary">Book Focusmate</button>
      </div>
      <div style="margin-top:10px"><button class="btn btn-volt" onclick="closeNudge()">Dismiss</button></div>
    </div>
  </div>

  <!-- Hidden players -->
  <div class="visually-hidden">
    <div id="musicPlayer"></div>
    <div id="noisePlayer"></div>
  <div id="hintPlayer"></div>
  </div>

  <script type="module" src="./nukes-v2.js"></script>
</body>
</html>